{% extends 'diary/base.html' %}

{% block content %}
  <h1>ÎšÎ±Ï„Î±Ï‡ÏÏÎ·ÏƒÎ· Î³Î¹Î± {{ date }}</h1>

  <form method="post" enctype="multipart/form-data">
    {% csrf_token %}

    <!-- Î ÎµÏÎ¹ÎµÏ‡ÏŒÎ¼ÎµÎ½Î¿ Î·Î¼Î­ÏÎ±Ï‚ -->
    <label for="content">Î ÎµÏÎ¹Î³ÏÎ±Ï†Î®:</label><br>
    <textarea name="content" rows="10" cols="60">{{ entry.content }}</textarea><br><br>

    <!-- Î”Î¹Î¬Î¸ÎµÏƒÎ· -->
    <label for="mood">Î”Î¹Î¬Î¸ÎµÏƒÎ·:</label><br>
    <select name="mood">
      <option value="">â€” Î•Ï€Î¹Î»Î¿Î³Î® â€”</option>
      <option value="happy" {% if entry.mood == "happy" %}selected{% endif %}>ğŸ˜Š Î§Î±ÏÎ¿ÏÎ¼ÎµÎ½Î¿Ï‚</option>
      <option value="sad" {% if entry.mood == "sad" %}selected{% endif %}>ğŸ˜¢ Î›Ï…Ï€Î·Î¼Î­Î½Î¿Ï‚</option>
      <option value="stressed" {% if entry.mood == "stressed" %}selected{% endif %}>ğŸ˜° Î‘Î³Ï‡Ï‰Î¼Î­Î½Î¿Ï‚</option>
      <option value="calm" {% if entry.mood == "calm" %}selected{% endif %}>ğŸ˜Œ Î‰ÏÎµÎ¼Î¿Ï‚</option>
      <option value="angry" {% if entry.mood == "angry" %}selected{% endif %}>ğŸ˜  Î˜Ï…Î¼Ï‰Î¼Î­Î½Î¿Ï‚</option>
    </select><br><br>

    <!-- ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î± -->
    <label for="tag">ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î±:</label><br>
    <select name="tag">
      <option value="">â€” Î•Ï€Î¹Î»Î¿Î³Î® â€”</option>
      <option value="work" {% if entry.tag == "work" %}selected{% endif %}>Î•ÏÎ³Î±ÏƒÎ¯Î±</option>
      <option value="health" {% if entry.tag == "health" %}selected{% endif %}>Î¥Î³ÎµÎ¯Î±</option>
      <option value="relationships" {% if entry.tag == "relationships" %}selected{% endif %}>Î£Ï‡Î­ÏƒÎµÎ¹Ï‚</option>
      <option value="personal" {% if entry.tag == "personal" %}selected{% endif %}>Î ÏÎ¿ÏƒÏ‰Ï€Î¹ÎºÎ¬</option>
      <option value="other" {% if entry.tag == "other" %}selected{% endif %}>Î†Î»Î»Î¿</option>
    </select><br><br>

    <!-- Highlights -->
    <label>Î£Î·Î¼Î±Î½Ï„Î¹ÎºÎ¬ Î£Î·Î¼ÎµÎ¯Î±:</label><br>
    <input type="checkbox" name="highlight_proud" {% if entry.highlights.proud %}checked{% endif %}> ÎˆÎ½Î¹Ï‰ÏƒÎ± Ï€ÎµÏÎ®Ï†Î±Î½Î¿Ï‚<br>
    <input type="checkbox" name="highlight_helped" {% if entry.highlights.helped %}checked{% endif %}> Î’Î¿Î®Î¸Î·ÏƒÎ± ÎºÎ¬Ï€Î¿Î¹Î¿Î½<br>
    <input type="checkbox" name="highlight_difficult" {% if entry.highlights.had_difficult_time %}checked{% endif %}> Î•Î¯Ï‡Î± Î´ÏÏƒÎºÎ¿Î»Î· ÏƒÏ„Î¹Î³Î¼Î®<br><br>

    <!-- Î•Î¹ÎºÏŒÎ½Î± -->
    <label for="image">Î•Î¹ÎºÏŒÎ½Î± Î·Î¼Î­ÏÎ±Ï‚:</label><br>
    {% if entry.image_base64 %}
      <img src="data:image/png;base64,{{ entry.image_base64 }}" width="150"><br>
    {% elif entry.image %}
      <img src="{{ entry.image.url }}" width="150"><br>
    {% endif %}
    <input type="file" name="image"><br><br>
    {% if entry.image %}
      <button type="button" id="remove-image-btn" class="btn btn-sm btn-danger mt-2">ğŸ—‘ï¸ Î”Î¹Î±Î³ÏÎ±Ï†Î® ÎµÎ¹ÎºÏŒÎ½Î±Ï‚</button>
    {% endif %}

    <img id="preview-image" src="#" alt="Î ÏÎ¿ÎµÏ€Î¹ÏƒÎºÏŒÏ€Î·ÏƒÎ· ÎµÎ¹ÎºÏŒÎ½Î±Ï‚" style="display: none; max-width: 150px; margin-top: 10px;"><br>
    {% if entry.image %}
    <input type="hidden" name="remove_image" id="remove-image-flag" value="false">
    {% endif %}
    <br><br>

    {% for badge in user.userbadge_set.all %}
      <span class="badge bg-success">{{ badge.badge_type }}</span>
    {% endfor %}


    <!-- Î”Î·Î¼ÏŒÏƒÎ¹Î¿ / Î™Î´Î¹Ï‰Ï„Î¹ÎºÏŒ -->
    <label>
      <input type="checkbox" name="is_public" {% if entry.is_public %}checked{% endif %}>
      Î‘Ï…Ï„Î® Î· ÎºÎ±Ï„Î±Ï‡ÏÏÎ·ÏƒÎ· ÎµÎ¯Î½Î±Î¹ Î´Î·Î¼ÏŒÏƒÎ¹Î±
    </label><br><br>

    <button type="submit">Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·</button>
  </form>

  <br><a href="{% url 'calendar' %}">â† Î•Ï€Î¹ÏƒÏ„ÏÎ¿Ï†Î® ÏƒÏ„Î¿ Î·Î¼ÎµÏÎ¿Î»ÏŒÎ³Î¹Î¿</a>
{% endblock %}
  
{% block scripts %}
  {{ block.super }}
  <script>
    document.querySelector('input[type="file"][name="image"]').addEventListener('change', function (event) {
      const preview = document.getElementById('preview-image');
      const file = event.target.files[0];

      const allowedTypes = ['image/jpeg', 'image/png', 'image/webp'];
      const maxSizeMB = 2;

      if (!allowedTypes.includes(file.type)) {
        alert('Î•Ï€Î¹Ï„ÏÎ­Ï€Î¿Î½Ï„Î±Î¹ Î¼ÏŒÎ½Î¿ ÎµÎ¹ÎºÏŒÎ½ÎµÏ‚ JPEG, PNG Î® WEBP.');
        event.target.value = '';
        preview.style.display = 'none';
        return;
      }

      if (file.size > maxSizeMB * 1024 * 1024) {
        alert(`Î¤Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± ÎµÎ¯Î½Î±Î¹ Î¼Î¹ÎºÏÏŒÏ„ÎµÏÎ¿ Î±Ï€ÏŒ ${maxSizeMB}MB.`);
        event.target.value = '';
        preview.style.display = 'none';
        return;
      }

      if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          preview.src = e.target.result;
          preview.style.display = 'block';
        };
        reader.readAsDataURL(file);
      } else {
        preview.src = '#';
        preview.style.display = 'none';
      }
    });
    document.getElementById('remove-image-btn').style.display = 'inline-block';
    document.getElementById('remove-image-flag').value = 'false';

    // ÎÎ­Î¿ event Î³Î¹Î± Ï„Î¿ ÎºÎ¿Ï…Î¼Ï€Î¯ Î´Î¹Î±Î³ÏÎ±Ï†Î®Ï‚ ÎµÎ¹ÎºÏŒÎ½Î±Ï‚
    document.getElementById('remove-image-btn').addEventListener('click', function () {
      const fileInput = document.querySelector('input[type="file"][name="image"]');
      const preview = document.getElementById('preview-image');
      const removeFlag = document.getElementById('remove-image-flag');

      fileInput.value = '';
      preview.src = '#';
      preview.style.display = 'none';
      this.style.display = 'none';
      removeFlag.value = 'true';
    });
  </script>
{% endblock %}
