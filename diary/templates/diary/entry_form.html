{% extends 'diary/base.html' %}

{% block content %}
  <h1>Καταχώρηση για {{ date }}</h1>

  <form method="post" enctype="multipart/form-data">
    {% csrf_token %}

    <!-- Περιεχόμενο ημέρας -->
    <label for="content">Περιγραφή:</label><br>
    <textarea name="content" rows="10" cols="60">{{ entry.content }}</textarea><br><br>

    <!-- Διάθεση -->
    <label for="mood">Διάθεση:</label><br>
    <select name="mood">
      <option value="">— Επιλογή —</option>
      <option value="happy" {% if entry.mood == "happy" %}selected{% endif %}>😊 Χαρούμενος</option>
      <option value="sad" {% if entry.mood == "sad" %}selected{% endif %}>😢 Λυπημένος</option>
      <option value="stressed" {% if entry.mood == "stressed" %}selected{% endif %}>😰 Αγχωμένος</option>
      <option value="calm" {% if entry.mood == "calm" %}selected{% endif %}>😌 Ήρεμος</option>
      <option value="angry" {% if entry.mood == "angry" %}selected{% endif %}>😠 Θυμωμένος</option>
    </select><br><br>

    <!-- Κατηγορία -->
    <label for="tag">Κατηγορία:</label><br>
    <select name="tag">
      <option value="">— Επιλογή —</option>
      <option value="work" {% if entry.tag == "work" %}selected{% endif %}>Εργασία</option>
      <option value="health" {% if entry.tag == "health" %}selected{% endif %}>Υγεία</option>
      <option value="relationships" {% if entry.tag == "relationships" %}selected{% endif %}>Σχέσεις</option>
      <option value="personal" {% if entry.tag == "personal" %}selected{% endif %}>Προσωπικά</option>
      <option value="other" {% if entry.tag == "other" %}selected{% endif %}>Άλλο</option>
    </select><br><br>

    <!-- Highlights -->
    <label>Σημαντικά Σημεία:</label><br>
    <input type="checkbox" name="highlight_proud" {% if entry.highlights.proud %}checked{% endif %}> Ένιωσα περήφανος<br>
    <input type="checkbox" name="highlight_helped" {% if entry.highlights.helped %}checked{% endif %}> Βοήθησα κάποιον<br>
    <input type="checkbox" name="highlight_difficult" {% if entry.highlights.had_difficult_time %}checked{% endif %}> Είχα δύσκολη στιγμή<br><br>

    <!-- Εικόνα -->
    <label for="image">Εικόνα ημέρας:</label><br>
    {% if entry.image_base64 %}
      <img src="data:image/png;base64,{{ entry.image_base64 }}" width="150"><br>
    {% elif entry.image %}
      <img src="{{ entry.image.url }}" width="150"><br>
    {% endif %}
    <input type="file" name="image"><br><br>
    {% if entry.image %}
      <button type="button" id="remove-image-btn" class="btn btn-sm btn-danger mt-2">🗑️ Διαγραφή εικόνας</button>
    {% endif %}

    <img id="preview-image" src="#" alt="Προεπισκόπηση εικόνας" style="display: none; max-width: 150px; margin-top: 10px;"><br>
    {% if entry.image %}
    <input type="hidden" name="remove_image" id="remove-image-flag" value="false">
    {% endif %}
    <br><br>

    {% for badge in user.userbadge_set.all %}
      <span class="badge bg-success">{{ badge.badge_type }}</span>
    {% endfor %}


    <!-- Δημόσιο / Ιδιωτικό -->
    <label>
      <input type="checkbox" name="is_public" {% if entry.is_public %}checked{% endif %}>
      Αυτή η καταχώρηση είναι δημόσια
    </label><br><br>

    <button type="submit">Αποθήκευση</button>
  </form>

  <br><a href="{% url 'calendar' %}">← Επιστροφή στο ημερολόγιο</a>
{% endblock %}
  
{% block scripts %}
  {{ block.super }}
  <script>
    document.querySelector('input[type="file"][name="image"]').addEventListener('change', function (event) {
      const preview = document.getElementById('preview-image');
      const file = event.target.files[0];

      const allowedTypes = ['image/jpeg', 'image/png', 'image/webp'];
      const maxSizeMB = 2;

      if (!allowedTypes.includes(file.type)) {
        alert('Επιτρέπονται μόνο εικόνες JPEG, PNG ή WEBP.');
        event.target.value = '';
        preview.style.display = 'none';
        return;
      }

      if (file.size > maxSizeMB * 1024 * 1024) {
        alert(`Το αρχείο πρέπει να είναι μικρότερο από ${maxSizeMB}MB.`);
        event.target.value = '';
        preview.style.display = 'none';
        return;
      }

      if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          preview.src = e.target.result;
          preview.style.display = 'block';
        };
        reader.readAsDataURL(file);
      } else {
        preview.src = '#';
        preview.style.display = 'none';
      }
    });
    document.getElementById('remove-image-btn').style.display = 'inline-block';
    document.getElementById('remove-image-flag').value = 'false';

    // Νέο event για το κουμπί διαγραφής εικόνας
    document.getElementById('remove-image-btn').addEventListener('click', function () {
      const fileInput = document.querySelector('input[type="file"][name="image"]');
      const preview = document.getElementById('preview-image');
      const removeFlag = document.getElementById('remove-image-flag');

      fileInput.value = '';
      preview.src = '#';
      preview.style.display = 'none';
      this.style.display = 'none';
      removeFlag.value = 'true';
    });
  </script>
{% endblock %}
